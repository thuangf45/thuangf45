name: Global Stats Sync

on:
  schedule:
    - cron: "0 */6 * * *" # Chạy mỗi 6 tiếng
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Fetch Global Data
        run: |
          # 1. Lấy danh sách toàn bộ Repo (Public + Private)
          REPO_LIST=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/users/thuangf45/repos?per_page=100")

          # 2. Tính toán Top Languages trên TOÀN BỘ hệ thống
          echo "{}" > all_languages.json
          for repo in $(echo $REPO_LIST | jq -r '.[].full_name'); do
            curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
              "https://api.github.com/repos/$repo/languages" > lang.json
            
            # Cộng dồn dung lượng byte của từng ngôn ngữ
            jq -s 'reduce .[] as $item ({}; . * $item | with_entries(.value = (if .key | in($item) then .value + $item[.key] else .value end)))' \
              all_languages.json lang.json > temp.json && mv temp.json all_languages.json
          done
          jq 'to_entries | sort_by(.value) | reverse | .[0:6] | from_entries' all_languages.json > top-langs.json

          # 3. Lấy tổng Commits toàn tài khoản (Search API)
          TOTAL_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/search/commits?q=author:thuangf45" | jq '.total_count // 0')

          # 4. Tính tổng Stars và Forks
          TOTAL_STARS=$(echo $REPO_LIST | jq '[.[].stargazers_count] | add // 0')
          TOTAL_FORKS=$(echo $REPO_LIST | jq '[.[].forks_count] | add // 0')

          # 5. Lấy số lượt tải LuciferCore từ NuGet
          # API NuGet trả về tổng lượt tải (totalDownloads) của package
          NUGET_DATA=$(curl -s https://azuresearch-usnc.nuget.org/query?q=packageid:LuciferCore)
          NUGET_DOWNLOADS=$(echo $NUGET_DATA | jq '.data[0].totalDownloads // 0')

          # 6. Lấy dữ liệu từ Dev.to
          curl -s "https://dev.to/api/articles?username=thuangf45" > articles.json
          DEVTO_POSTS=$(jq 'length' articles.json)
          DEVTO_REACTIONS=$(jq '[.[] | .public_reactions_count // 0] | add // 0' articles.json)

          # 7. Xuất các file JSON tổng hợp
          echo "{\"commits\":$TOTAL_COMMITS,\"stars\":$TOTAL_STARS,\"forks\":$FORKS,\"nuget_downloads\":$NUGET_DOWNLOADS}" > github-stats.json
          echo "{\"posts\":$DEVTO_POSTS,\"reactions\":$DEVTO_REACTIONS}" > devto.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add top-langs.json github-stats.json devto.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Global Dashboard Stats [skip ci]"
            git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/thuangf45/thuangf45.git HEAD:main
          fi
