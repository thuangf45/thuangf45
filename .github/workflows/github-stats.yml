name: GitHub Stats Self-hosted

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Fetch and Calculate Global Data
        run: |
          # 1. Lấy tổng Commits từ toàn bộ Public & Private Repos (Sử dụng Search API)
          # Query author:thuangf45 trả về toàn bộ commit gắn với identity của bạn
          TOTAL_COMMITS=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/search/commits?q=author:thuangf45" | jq '.total_count // 0')

          # 2. Lấy danh sách Repo để tính tổng Stars và Forks
          # Per_page=100 để đảm bảo quét hết các project lab và framework
          REPO_DATA=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            "https://api.github.com/users/thuangf45/repos?per_page=100")
          
          TOTAL_STARS=$(echo $REPO_DATA | jq '[.[].stargazers_count] | add // 0')
          TOTAL_FORKS=$(echo $REPO_DATA | jq '[.[].forks_count] | add // 0')

          # 3. Lấy dữ liệu ngôn ngữ (từ repo profile chính)
          curl -s -H "Authorization: token ${{ secrets.GH_PAT }}" \
            https://api.github.com/repos/thuangf45/thuangf45/languages -o languages.json
          jq 'to_entries | sort_by(.value) | reverse | .[0:6] | from_entries' languages.json > top-langs.json

          # 4. Xuất file JSON tổng hợp
          echo "{\"commits\":$TOTAL_COMMITS,\"stars\":$TOTAL_STARS,\"forks\":$TOTAL_FORKS}" > github-stats.json
          
          cat github-stats.json

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add top-langs.json github-stats.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Global GitHub stats [skip ci]"
            # Ép quyền push bằng PAT để đảm bảo ghi được vào Repo Profile
            git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/thuangf45/thuangf45.git HEAD:main
          fi
